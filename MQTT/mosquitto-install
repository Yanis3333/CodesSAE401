#!/bin/bash

configure_mosquitto() {
    printf "\nDébut de l'installation\n"
    apt update && apt upgrade -y
    apt install mosquitto mosquitto-clients openssl -y
    service mosquitto stop
    mkdir -p /etc/mosquitto/certs

    country = "FR"
    state = "BFC"
    city = "Montbeliard"
    organization = "IUT"
    common_name_serv = ""
    common_name = "192.168.1.50"

    openssl genrsa -des3 -out ca.key 2048
    openssl req -new -x509 -days 1826 -key ca.key -out ca.crt\
        -subj "/C=$country/ST=$state/L=$city/O=$organization/CN=$common_name_serv"

    openssl genrsa -out server.key 2048
    openssl req -new -out server.csr -key server.key \
        -subj "/C=$country/ST=$state/L=$city/O=$organization/CN=$common_name"

    openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 360

    cp server.* /etc/mosquitto/certs/
    cp ca.* /etc/mosquitto/certs/
    chmod 644 /etc/mosquitto/certs/*

    #scp grp-1-iom@192.168.1.50:/etc/mosquitto/certs/ca.crt pi@192.168.1.60:/home/pi/Documents/ca.crt
    #scp grp-1-iom@192.168.1.50:/etc/mosquitto/certs/ca.crt /home/teto/Documents/Projet/Bash/ca.crt

    printf "\nConfiguration de Mosquitto\n"
    # Configuration de Mosquitto
    echo "listener 8883
allow_anonymous false
cafile /etc/mosquitto/certs/ca.crt
keyfile /etc/mosquitto/certs/server.key
certfile /etc/mosquitto/certs/server.crt" > /etc/mosquitto/conf.d/default.conf
    printf "\nInstallation Terminé.\n"

}

# Appel de la fonction
configure_mosquitto
